<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¥∏‡µç‡¥Æ‡¥æ‡µº‡¥ü‡µç‡¥ü‡µç ‡¥´‡¥æ‡¥Ç ‡¥Ö‡¥∏‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡¥®‡µç‡¥±‡µç - ‡¥ï‡µÉ‡¥∑‡¥ø‡¥≠‡µÇ‡¥Æ‡¥ø ‡¥°‡¥æ‡¥±‡µç‡¥±</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --green-primary: #4CAF50; --green-light: #e8f5e9; --gray-text: #555; --border-color: #ddd; --background-color: #f0f4f7; --success-dot: #28a745; --dark-green-bg: #4c8a5a; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; line-height: 1.6; color: #333; background-color: var(--background-color); }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 50px; background: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .navbar-logo { display: flex; align-items: center; gap: 10px; }
        .navbar-logo .title { font-size: 1.5rem; font-weight: 600; }
        .navbar-logo .tagline { font-size: 0.8rem; color: var(--gray-text); }
        .navbar-menu { display: flex; align-items: center; gap: 20px; }
        .navbar-menu a { text-decoration: none; color: #555; font-weight: 500; padding: 8px 15px; border-radius: 20px; transition: background-color 0.3s, color 0.3s; }
        .navbar-menu a:hover, .navbar-menu a.active { background-color: var(--green-primary); color: white; }
        .main-container { padding: 20px; max-width: 950px; margin: 20px auto; }
        .form-section-container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; gap: 40px; flex-wrap: wrap; }
        .form-column { flex: 1; min-width: 300px; background-color: #e8f5e9; padding: 20px; border-radius: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .submit-button { text-align: center; margin-top: 20px; }
        .submit-button button { padding: 12px 30px; background-color: #4CAF50; color: white; border: none; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s; }
        .submit-button button:hover { background-color: var(--dark-green-bg); }
        .iot-sensors-status-box { margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9f9f9; }
        .status-title { font-weight: 600; color: var(--green-primary); margin-bottom: 10px; display: flex; align-items: center; }
        .sensor-state.active { color: var(--success-dot); }
        .fa-network-wired::before { content: "‚öôÔ∏è"; margin-right: 5px; }
        .welcome-message { text-align: center; margin-bottom: 10px; font-weight: 600; color: #333; }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-logo">
            <div>
                <div class="title">üå±‡¥∏‡µç‡¥Æ‡¥æ‡µº‡¥ü‡µç‡¥ü‡µç ‡¥´‡¥æ‡¥Ç ‡¥Ö‡¥∏‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡¥®‡µç‡¥±‡µç</div>
                <div class="tagline">IOT ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µÅ‡¥≥‡µç‡¥≥ ‡¥ï‡µÉ‡¥∑‡¥ø ‡¥Æ‡¥æ‡µº‡¥ó‡µç‡¥ó‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂ ‡¥∏‡¥Ç‡¥µ‡¥ø‡¥ß‡¥æ‡¥®‡¥Ç</div>
            </div>
        </div>
        <div class="navbar-menu">
              <a href="index4.html" >‡¥π‡µã‡¥Ç</a>
            <a href="farmdata4.html"class="active">‡¥´‡¥æ‡¥Ç ‡¥°‡¥æ‡¥±‡µç‡¥±</a>
            <a href="results4.html">‡¥´‡¥≤‡¥ô‡µç‡¥ô‡µæ</a>
            <a href="monitoring4.html">‡¥®‡¥ø‡¥∞‡µÄ‡¥ï‡µç‡¥∑‡¥£‡¥Ç</a>
            <a href="profile4.html">‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ</a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="welcome-message" id="welcome-user"></div>

        <h1 style="text-align:center;">‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ï‡µÉ‡¥∑‡¥ø‡¥≠‡µÇ‡¥Æ‡¥ø‡¥Ø‡µÜ‡¥ï‡µç‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥û‡¥ô‡µç‡¥ô‡¥≥‡µã‡¥ü‡µç ‡¥™‡¥±‡¥Ø‡µÅ‡¥ï</h1>
        <h3 style="text-align:center;">IOT ‡¥∂‡µÅ‡¥™‡¥æ‡µº‡¥∂ ‡¥≤‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ï‡µÉ‡¥∑‡¥ø‡¥≠‡µÇ‡¥Æ‡¥ø ‡¥µ‡¥ø‡¥∂‡¥¶‡¥æ‡¥Ç‡¥∂‡¥ô‡µç‡¥ô‡µæ ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï</h3>

        <form id="farm-data-form">
            <div class="form-section-container">
                <div class="form-column">
                    <h3>‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ</h3>
                    <div class="form-group"><label for="soil-type">‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥§‡¥∞‡¥Ç</label>
                        <select id="soil-type" required>
                            <option value="">‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥§‡¥∞‡¥Ç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option><option value="Sandy">‡¥Æ‡¥£‡µΩ‡¥Æ‡¥£‡µç‡¥£‡µç</option>
                            <option value="Loamy">‡¥™‡¥∂‡¥ø‡¥Æ‡¥∞‡¥æ‡¥∂‡¥ø</option><option value="Clay">‡¥ï‡¥≥‡¥ø‡¥Æ‡¥£‡µç‡¥£‡µç</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="ph-level">pH ‡¥≤‡µÜ‡¥µ‡µΩ</label>
                        <input type="number" step="0.1" id="ph-level" placeholder="‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥§‡µç‡¥§‡¥ø‡¥®‡µç: 6.5" required>
                    </div>
                    <div class="form-group"><label for="moisture">‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥≤‡µÜ ‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç %</label>
                        <input type="number" id="moisture" placeholder="‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥§‡µç‡¥§‡¥ø‡¥®‡µç: 45" required>
                    </div>
                    <div class="form-group"><label for="nitrogen">‡¥®‡µà‡¥ü‡µç‡¥∞‡¥ú‡µª (N)</label>
                        <input type="number" id="nitrogen" placeholder="‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥§‡µç‡¥§‡¥ø‡¥®‡µç: 80" required>
                    </div>
                    <div class="form-group"><label for="phosphorus">‡¥´‡µã‡¥∏‡µç‡¥´‡¥±‡¥∏‡µç (P)</label>
                        <input type="number" id="phosphorus" placeholder="‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥§‡µç‡¥§‡¥ø‡¥®‡µç: 60" required>
                    </div>
                    <div class="form-group"><label for="potassium">‡¥™‡µä‡¥ü‡µç‡¥ü‡¥æ‡¥∏‡µç‡¥Ø‡¥Ç (K)</label>
                        <input type="number" id="potassium" placeholder="‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥§‡µç‡¥§‡¥ø‡¥®‡µç: 40" required>
                    </div>
                </div>

                <div class="form-column">
                    <h3>‡¥ï‡µÉ‡¥∑‡¥ø‡¥≠‡µÇ‡¥Æ‡¥ø ‡¥µ‡¥ø‡¥∂‡¥¶‡¥æ‡¥Ç‡¥∂‡¥ô‡µç‡¥ô‡µæ</h3>
                    <div class="form-group"><label for="location">‡¥∏‡µç‡¥•‡¥≤‡¥Ç</label>
                        <input type="text" id="location" placeholder="‡¥®‡¥ó‡¥∞‡¥Ç, ‡¥∏‡¥Ç‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï" required>
                    </div>
                    <div class="form-group"><label for="prev-crop">‡¥Æ‡µÅ‡µª‡¥™‡¥§‡µç‡¥§‡µÜ ‡¥µ‡¥ø‡¥≥</label>
                        <select id="prev-crop" required>
                            <option value="">‡¥Æ‡µÅ‡µª‡¥™‡¥§‡µç‡¥§‡µÜ ‡¥µ‡¥ø‡¥≥ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option><option value="Corn">‡¥ö‡µã‡¥≥‡¥Ç</option>
                            <option value="Soybeans">‡¥∏‡µã‡¥Ø‡¥æ‡¥¨‡µÄ‡µª‡¥∏‡µç</option><option value="Rice">‡¥®‡µÜ‡¥≤‡µç‡¥≤‡µç</option>
                            <option value="Wheat">‡¥ó‡µã‡¥§‡¥Æ‡µç‡¥™‡µç</option><option value="Cotton">‡¥™‡¥∞‡µÅ‡¥§‡µç‡¥§‡¥ø</option>
                            <option value="Sugarcane">‡¥ï‡¥∞‡¥ø‡¥Æ‡µç‡¥™‡µç</option><option value="No Previous Crop">‡¥Æ‡µÅ‡µª‡¥™‡¥§‡µç‡¥§‡µÜ ‡¥µ‡¥ø‡¥≥ ‡¥á‡¥≤‡µç‡¥≤</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="temp">‡¥∂‡¥∞‡¥æ‡¥∂‡¥∞‡¥ø ‡¥§‡¥æ‡¥™‡¥®‡¥ø‡¥≤ (¬∞C)</label>
                        <input type="number" id="temp" placeholder="‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥§‡µç‡¥§‡¥ø‡¥®‡µç: 25" required>
                        <div class="iot-sensors-status-box">
                            <h5 class="status-title"><i class="fas fa-network-wired"></i> IoT ‡¥∏‡µÜ‡µª‡¥∏‡¥±‡µÅ‡¥ï‡¥≥‡µÅ‡¥ü‡µÜ ‡¥®‡¥ø‡¥≤</h5>
                            <div class="status-items-container">
                                <div class="sensor-status-item"><span class="status-dot active-dot"></span><span class="sensor-name">‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥Æ‡µã‡¥£‡¥ø‡¥±‡µç‡¥±‡µº:</span><span class="sensor-state active">‡¥∏‡¥ú‡µÄ‡¥µ‡¥Ç</span></div>
                                <div class="sensor-status-item"><span class="status-dot active-dot"></span><span class="sensor-name">‡¥ï‡¥æ‡¥≤‡¥æ‡¥µ‡¥∏‡µç‡¥•‡¥æ ‡¥∏‡µç‡¥±‡µç‡¥±‡µá‡¥∑‡µª:</span><span class="sensor-state active">‡¥∏‡¥ú‡µÄ‡¥µ‡¥Ç</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="submit-button">
                <button type="submit">IOT ‡¥∂‡µÅ‡¥™‡¥æ‡µº‡¥∂ ‡¥®‡µá‡¥ü‡µÅ‡¥ï</button>
            </div>
        </form>
    </div>

<script>
// --- Configuration ---
const MAX_FREE_SUBMISSIONS = 5; 
const MAX_PREMIUM_SUBMISSIONS = 30; // New limit after payment/upgrade
const UPGRADE_URL = "upgrade4.html"; 
const USER_DATA_KEY = "currentUser";
const PREMIUM_STATUS_KEY = "isPremium_"; // Key to store premium status (user-specific)
const FORM_DATA_PREFIX = "farmData_";
const SUBMISSION_COUNT_PREFIX = "farmSubmissionCount_";

// --- Login Enforcement ---
const currentUser = localStorage.getItem(USER_DATA_KEY);
if (!currentUser) {
    alert('You must log in to access the farm data form.');
    window.location.href = 'login4.html'; // Ensure this is your login page
} else {
    // Update the welcome message if logged in
    document.getElementById('welcome-user').innerText = `‡¥∏‡µç‡¥µ‡¥æ‡¥ó‡¥§‡¥Ç, ${currentUser}!`;
}

// --- Cost Calculation Logic ---
function calculateTotalCost(data) {
    // Recommended values for a generic crop (can be made dynamic)
    const N_req = 100, P_req = 80, K_req = 60, M_req = 50, pH_req = 6.5;

    // Placeholder Costs (Cost per unit deficiency or flat fee)
    const C_N = 2, C_P = 3, C_K = 2.5; // Cost per unit (e.g., kg/ha) of N, P, K needed
    const C_w = 1; ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Cost per unit (%) of moisture deficiency (e.g., per 1% below 50%)
    const C_treatment = 10; ¬† ¬† ¬† ¬† ¬† ¬†// Cost per unit of pH deviation (e.g., per 0.1 pH deviation from 6.5)
    const C_soilmonitor = 50; ¬† ¬† ¬† // Flat fee for IoT Soil Monitor maintenance
    const C_weatherstation = 50; ¬† ¬† ¬† // Flat fee for IoT Weather Station maintenance

    // 1. Fertilizer Cost (only calculate cost for deficiency, Math.max(0, ...) ensures cost is 0 if level is sufficient)
    const fertilizerCost = 
        Math.max(0, (N_req - data.N) * C_N) + 
        Math.max(0, (P_req - data.P) * C_P) + 
        Math.max(0, (K_req - data.K) * C_K);

    // 2. Irrigation Cost
    const irrigationCost = Math.max(0, (M_req - data.moisture) * C_w);

    // 3. Soil Treatment Cost (e.g., lime for low pH, sulfur for high pH)
    const soilTreatmentCost = Math.abs(pH_req - data.ph) * 10 * C_treatment; // Multiply by 10 for better scale

    // 4. IoT Cost (Flat fee for using the system/sensors)
    const IoTCost = C_soilmonitor + C_weatherstation;

    const totalCost = fertilizerCost + irrigationCost + soilTreatmentCost + IoTCost;

    return { fertilizerCost, irrigationCost, soilTreatmentCost, IoTCost, totalCost };
}


// --- Form Submission Logic ---
document.getElementById('farm-data-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const SUBMISSION_COUNT_KEY = SUBMISSION_COUNT_PREFIX + currentUser;
    const PREMIUM_KEY = PREMIUM_STATUS_KEY + currentUser;
    
    let submissionCount = parseInt(localStorage.getItem(SUBMISSION_COUNT_KEY)) || 0; 
    
    // Check if the user is a premium member
    const isPremium = localStorage.getItem(PREMIUM_KEY) === 'true';
    const currentLimit = isPremium ? MAX_PREMIUM_SUBMISSIONS : MAX_FREE_SUBMISSIONS;

    // --- Submission Limit Check ---
    if (submissionCount >= currentLimit) {
        if (isPremium) {
             // For premium users who might have hit the 30 limit
             alert(`${currentUser}, ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ${currentLimit} ‡¥∏‡¥Æ‡µº‡¥™‡µç‡¥™‡¥£‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡µç‡¥∞‡µÄ‡¥Æ‡¥ø‡¥Ø‡¥Ç ‡¥™‡¥∞‡¥ø‡¥ß‡¥ø‡¥Ø‡¥ø‡¥≤‡µÜ‡¥§‡µç‡¥§‡¥ø. ‡¥é‡¥®‡µç‡¥±‡µº‡¥™‡µç‡¥∞‡µà‡¥∏‡µç ‡¥™‡µç‡¥≤‡¥æ‡¥®‡¥ø‡¥®‡¥æ‡¥Ø‡¥ø ‡¥™‡¥ø‡¥®‡µç‡¥§‡µÅ‡¥£‡¥Ø‡µÅ‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥¨‡¥®‡µç‡¥ß‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥ï.`);
        } else {
            // For free users who hit the 5 limit
            alert(`${currentUser}, ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ${currentLimit} ‡¥∏‡¥Æ‡µº‡¥™‡µç‡¥™‡¥£‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥∏‡µó‡¥ú‡¥®‡µç‡¥Ø ‡¥™‡¥∞‡¥ø‡¥ß‡¥ø‡¥Ø‡¥ø‡¥≤‡µÜ‡¥§‡µç‡¥§‡¥ø. ${MAX_PREMIUM_SUBMISSIONS} ‡¥∏‡¥Æ‡µº‡¥™‡µç‡¥™‡¥£‡¥ô‡µç‡¥ô‡µæ‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø ‡¥™‡µç‡¥∞‡µÄ‡¥Æ‡¥ø‡¥Ø‡¥§‡µç‡¥§‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥™‡µç‚Äå‡¥ó‡µç‡¥∞‡µá‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï.`);
            window.location.href = UPGRADE_URL;
        }
        return; 
    }

    // 1. Collect Form Data
    const data = {
        soilType: document.getElementById('soil-type').value, 
        ph: parseFloat(document.getElementById('ph-level').value),
        moisture: parseFloat(document.getElementById('moisture').value), 
        N: parseFloat(document.getElementById('nitrogen').value),
        P: parseFloat(document.getElementById('phosphorus').value), 
        K: parseFloat(document.getElementById('potassium').value),
        location: document.getElementById('location').value, 
        prevCrop: document.getElementById('prev-crop').value,
        temp: parseFloat(document.getElementById('temp').value)
    };

    // 2. Calculate Costs
    const costs = calculateTotalCost(data);

    // 3. Combine Data and Costs
    const farmResults = {
        ...data, // Contains all input data
        ...costs, // Contains all cost breakdowns and totalCost
        timestamp: new Date().toISOString()
    };

    // 4. Save User-Specific Results
    localStorage.setItem(FORM_DATA_PREFIX + currentUser, JSON.stringify(farmResults));
    
    // 5. Update Submission Count
    submissionCount++;
    localStorage.setItem(SUBMISSION_COUNT_KEY, submissionCount);
    
    // 6. Redirect to Results
    window.location.href = "results4.html";
});
</script>
</body>
</html>